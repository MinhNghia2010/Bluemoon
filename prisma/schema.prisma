// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model for authentication
model User {
  id        String   @id @default(cuid())
  username  String   @unique
  password  String
  name      String
  email     String   @unique
  role      String   @default("admin") // admin, manager, staff
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Household model - apartment units and residents
model Household {
  id         String    @id @default(cuid())
  unit       String    @unique // e.g., "101", "102"
  area       Float?    // Area in m²
  floor      Int?      // Floor number
  moveInDate DateTime? // Move-in date
  phone      String
  email      String
  status     String    @default("active") // active, inactive
  balance    Float     @default(0) // Outstanding balance (pending + overdue payments)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  // Owner relation - links to HouseholdMember
  ownerId    String?   @unique // Reference to the owner member (one member can only own one household)
  owner      HouseholdMember? @relation("HouseholdOwner", fields: [ownerId], references: [id], onDelete: SetNull)

  // Relations
  members      HouseholdMember[] @relation("HouseholdMembers")
  payments     Payment[]
  parkingSlots ParkingSlot[]
  utilityBills UtilityBill[]

  // Indexes for faster queries
  @@index([status])
  @@index([ownerId])
}

// Household Member model - residents in a household
model HouseholdMember {
  id              String    @id @default(cuid())
  name            String    // Full name
  dateOfBirth     DateTime  // Date of birth
  cccd            String    @unique // Căn cước công dân (National ID)
  profilePic      String?   // Optional profile picture URL
  
  // Residence information
  residenceType   String    @default("permanent") // permanent, temporary
  relationToOwner String?   // Relation to the household owner (self, spouse, child, parent, etc.)
  status          String    @default("living") // living, moved_out, deceased
  moveInDate      DateTime? // When they moved into this household
  moveOutDate     DateTime? // When they left (null if still living)
  note            String?   // Additional notes
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations - householdId can be null for people who moved out
  householdId String?
  household   Household? @relation("HouseholdMembers", fields: [householdId], references: [id], onDelete: SetNull)

  // Owner of households (a member can be owner of one household)
  ownedHousehold Household? @relation("HouseholdOwner")

  // Vehicles owned by this member
  ownedVehicles ParkingSlot[]

  // Temporary absence records (when they're temporarily away)
  temporaryAbsences TemporaryAbsence[]
  
  // Temporary residence records (for temporary residents)
  temporaryResidences TemporaryResidence[]
  
  @@index([status])
  @@index([residenceType])
}

// Temporary Absence model (Tạm vắng) - for residents temporarily away from the apartment
model TemporaryAbsence {
  id                  String    @id @default(cuid())
  registrationNumber  String?   // Mã giấy tạm vắng
  destination         String?   // Nơi đến
  startDate           DateTime  // Ngày bắt đầu tạm vắng
  endDate             DateTime? // Ngày kết thúc (null if ongoing)
  reason              String?   // Lý do tạm vắng
  status              String    @default("active") // active, returned, cancelled
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  memberId String
  member   HouseholdMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([status])
}

// Temporary Residence model (Tạm trú) - for people temporarily residing in the apartment
model TemporaryResidence {
  id                  String    @id @default(cuid())
  registrationNumber  String?   // Mã giấy tạm trú
  registrantPhone     String?   // Số điện thoại người đăng ký
  currentAddress      String?   // Địa chỉ thường trú
  startDate           DateTime  // Ngày bắt đầu tạm trú
  endDate             DateTime? // Ngày kết thúc (null if ongoing)
  reason              String?   // Lý do tạm trú
  status              String    @default("active") // active, expired, cancelled
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  memberId String
  member   HouseholdMember @relation(fields: [memberId], references: [id], onDelete: Cascade)

  @@index([memberId])
  @@index([status])
}

// Fee Category model - types of fees
model FeeCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  amount      Float
  frequency   String   // monthly, quarterly, annual, one-time
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  payments Payment[]
}

// Payment model - fee collection records
model Payment {
  id            String    @id @default(cuid())
  amount        Float
  status        String    @default("pending") // pending, collected, overdue
  dueDate       DateTime
  paymentDate   DateTime?
  paymentMethod String?   // cash, bank_transfer, card
  notes         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  householdId   String
  household     Household   @relation(fields: [householdId], references: [id], onDelete: Cascade)
  feeCategoryId String
  feeCategory   FeeCategory @relation(fields: [feeCategoryId], references: [id], onDelete: Cascade)

  // Indexes for faster queries
  @@index([status])
  @@index([householdId])
  @@index([dueDate])
}

// Parking Slot model
model ParkingSlot {
  id           String   @id @default(cuid())
  slotNumber   String   @unique // e.g., "P-001"
  type         String   // car, motorcycle, bicycle
  licensePlate String?  // Vehicle license plate number
  status       String   @default("available") // available, occupied, reserved
  monthlyFee   Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  householdId String?
  household   Household? @relation(fields: [householdId], references: [id], onDelete: SetNull)
  memberId    String?
  member      HouseholdMember? @relation(fields: [memberId], references: [id], onDelete: Cascade)

  // Indexes for faster queries
  @@index([type])
  @@index([householdId])
  @@index([memberId])
  @@index([status])
}

// Utility Bill model - combined utility billing per household
model UtilityBill {
  id               String    @id @default(cuid())
  // Billing period
  periodStart      DateTime
  periodEnd        DateTime
  month            String    // e.g., "December 2025"
  dueDate          DateTime
  // Electricity
  electricityUsage Float     @default(0) // kWh
  electricityRate  Float     @default(0.15) // $/kWh
  electricityCost  Float     @default(0)
  // Water
  waterUsage       Float     @default(0) // m³
  waterRate        Float     @default(1.5) // $/m³
  waterCost        Float     @default(0)
  // Internet
  internetCost     Float     @default(0)
  // Total
  totalAmount      Float     @default(0) // Sum of all costs
  // Status
  status           String    @default("pending") // pending, paid, overdue
  paidDate         DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  householdId String
  household   Household @relation(fields: [householdId], references: [id], onDelete: Cascade)

  // Indexes for faster queries
  @@index([status])
  @@index([householdId])
  @@index([dueDate])
}

// Settings model - system configuration
model Setting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
